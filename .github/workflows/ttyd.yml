name: Persistent 12-Hour ttyd VM

on:
  workflow_dispatch:

jobs:
  start-vm:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Fetch vm-data branch
        run: |
          git fetch origin vm-data || echo "No vm-data branch found."
          git checkout vm-data -- vm_data || echo "No vm_data to restore"

      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y unzip curl

      - name: Download ttyd
        run: |
          wget https://github.com/tsl0922/ttyd/releases/download/1.7.3/ttyd_linux.x86_64 -O ttyd
          chmod +x ttyd

      - name: Download cloudflared
        run: |
          wget https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64 -O cloudflared
          chmod +x cloudflared

      - name: Run start.sh
        run: |
          chmod +x start.sh
          ./start.sh
