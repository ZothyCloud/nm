name: Persistent 12-Hour ttyd VM

on:
  workflow_dispatch:

jobs:
  start-vm:
    runs-on: ubuntu-latest
    steps:
      - name: üì¶ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üõ†Ô∏è Install dependencies
        run: |
          sudo apt update
          sudo apt install -y git curl unzip

      - name: üîÅ Restore backup from vm-data (if it exists)
        run: |
          git fetch origin vm-data || echo "No vm-data branch found."
          if git show-ref --verify --quiet refs/remotes/origin/vm-data; then
            git switch -c vm-data origin/vm-data
            mkdir -p /home/runner/restored_data
            cp -r * /home/runner/restored_data/
            cd /home/runner/work/nm/nm
          fi

      - name: üöÄ Start ttyd on port 7681
        run: |
          curl -L https://github.com/tsl0922/ttyd/releases/download/1.7.7/ttyd_linux.x86_64 -o ttyd
          chmod +x ttyd
          nohup ./ttyd -p 7681 bash > ttyd.log 2>&1 &

      - name: üåê Start Cloudflare Tunnel
        run: |
          curl -L https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64 -o cloudflared
          chmod +x cloudflared
          nohup ./cloudflared tunnel --url http://localhost:7681 > tunnel.log 2>&1 &
          sleep 10
          grep -Eo "https://[a-zA-Z0-9.-]+\.trycloudflare\.com" tunnel.log || echo "Tunnel URL not found."

      - name: ‚ñ∂Ô∏è Run your next program (optional)
        run: |
          chmod +x start.sh || true
          ./start.sh || echo "No start.sh found or failed"
          echo "‚úÖ Program finished. Keeping VM alive..."
          sleep 43200  # sleep for 12 hours
