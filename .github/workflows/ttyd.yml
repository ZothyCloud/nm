name: Persistent 12-Hour ttyd VM

on:
  workflow_dispatch:

jobs:
  start-vm:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Restore previous VM data
      run: |
        git fetch origin vm-data || echo "No vm-data branch found."
        if git show origin/vm-data:vm_data >/dev/null 2>&1; then
          git checkout origin/vm-data -- vm_data
        else
          mkdir -p vm_data
        fi

    - name: Start VM with ttyd + Cloudflare
      run: bash start.sh

    - name: Commit & Push VM data
      if: always()
      run: |
        git config --global user.email "save@vm.com"
        git config --global user.name "VM Backup"
        git checkout --orphan temp-backup
        git rm -rf .
        cp -r vm_data/* .
        git add .
        git commit -m "Backup VM data"
        git branch -D vm-data || true
        git branch vm-data
        git push -f origin vm-data
