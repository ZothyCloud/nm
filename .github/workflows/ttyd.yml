name: Persistent 12-Hour ttyd VM

on:
  workflow_dispatch:

jobs:
  start-vm:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y git curl unzip

      - name: Restore previous backup
        run: |
          echo "ğŸ”„ Restoring previous backup from branch vm-data..."
          git fetch origin vm-data
          git checkout vm-data -- vm_data || echo "No previous backup found."
          echo "âœ… Backup restored (if any)."

      - name: Move to next steps
        run: |
          echo "ğŸš€ Moving to next program..."
          chmod +x vm_data/start.sh || true
          ./vm_data/start.sh || echo "â— start.sh failed or not found."
          echo "âœ… Continued with main program."

      - name: Keep VM alive for 12 hours with ttyd (optional)
        run: |
          curl -s https://api.github.com/repos/tsl0922/ttyd/releases/latest \
            | grep "browser_download_url.*linux.x86_64" \
            | cut -d '"' -f 4 \
            | wget -i - -O ttyd
          chmod +x ttyd
          ./ttyd -p 7681 bash &
          echo "ğŸŒ ttyd running on port 7681"
          sleep 43200  # 12 hours
