name: Persistent 12-Hour SSH VM with ttyd

on:
  workflow_dispatch:

jobs:
  start-vm:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“ Checkout repo
        uses: actions/checkout@v3

      - name: â¬ Download & install ttyd + SSHX
        run: |
          curl -s https://raw.githubusercontent.com/AnonyX69420/SSHX/main/install.sh | bash
          curl -Lo ttyd https://github.com/tsl0922/ttyd/releases/download/1.7.7/ttyd_linux.x86_64
          chmod +x ttyd
          sudo mv ttyd /usr/local/bin/

      - name: ğŸš€ Start ttyd & SSHX
        run: |
          nohup ttyd -p 7681 bash > ttyd.log 2>&1 &
          sshx --name "ZothyBackupVM" --runtime 6h &

      - name: ğŸ•’ Sleep for setup
        run: sleep 15

      - name: ğŸ“¦ Save VM Data
        run: |
          mkdir -p save/data
          rsync -a --exclude='save' /home/runner/ save/data/

      - name: ğŸ’¾ Commit saved data
        run: |
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions"
          git add save/data
          git commit -m "ğŸ—ƒï¸ Save VM data - $(date)" || echo "Nothing to commit"
          git push https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }} HEAD:vm-data
